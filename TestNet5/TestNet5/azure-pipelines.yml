variables:
  project: 'teste-net5'
  agentPool: 'AwsHMG4'
  agentType: 'net5'
  buildConfiguration: 'Release'

stages: 
- stage: CreateAgent
  pool:
      name: $(agentPool)
      
  jobs: 
      - job: CreateAgent
        displayName: Spining up Agent
        steps:
          - checkout: none
          - script: | 
              curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
              chmod 700 get_helm.sh
              ./get_helm.sh
              helm repo add emberstack https://emberstack.github.io/helm-charts
              helm repo update
              sudo helm upgrade --install --wait --namespace $(project) --set pipelines.url=https://dev.azure.com/alm-animaeducacao --set pipelines.pat=b5kqhw7adz423g7pjt77tud3tzwhapynggvz3rpdbcdj4fwmmbxa --set pipelines.pool=$(agentPool) $(agentType)-$(Build.BuildId) emberstack/azure-pipelines-agent
              sleep 40
            displayName: "Create an Agent- HELM"
            
- stage: Teste
  pool:
      name: $(agentPool)
      demands:
      - Agent.Name -equals $(agentType)-$(Build.BuildId)-azure-pipelines-agent-0
      
  jobs: 
      - job: Teste
        displayName: Teste
        steps:
          - checkout: none
          - script: | 
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
              sleep 3
            displayName: "Teste Sleep"
    
- stage: Build
  pool:
      name: $(agentPool)
      demands:
      - Agent.Name -equals $(agentType)-$(Build.BuildId)-azure-pipelines-agent-0
  
  jobs: 
      - job: UseNETCore
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET Core sdk 5.0.101'
            inputs:
               packageType: 'sdk'
               version: '5.0.101'
               includePreviewVersions: true

      - job: BuildNetCore
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Build .NET Core 5'
            inputs:
               command: build
               projects: '**/*.csproj'
               arguments: '--configuration $(buildConfiguration)' # Update this to match your need)'
  
- stage: DeleteAgent
  condition: always()
  pool:
      name: $(agentType)-$(Build.BuildId)

  jobs:
    - job: HelmUninstall
      timeoutInMinutes: 1
      steps:
        - checkout: none
        - script: |
            helm uninstall --namespace $(project) $(agentType)-$(Build.BuildId)
          displayName: "Delete an Agent - HELM"
